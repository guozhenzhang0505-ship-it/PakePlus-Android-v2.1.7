<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººäººç”ŸKPIç³»ç»Ÿ v31.0 (å•æ–‡ä»¶æ— é™å­˜å‚¨ç‰ˆ)</title>
    <style>
        /* ==================== æ ·å¼è¡¨ (CSS) ==================== */
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --purple-color: #8b5cf6;
            --scheme-color: #0ea5e9;
            --mid-color: #f59e0b; 
            --long-color: #0d9488; 
            --sl-color: #7c3aed; 
            --life-color: #db2777;
            --cat-header-bg: #e0f2fe;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: 80vh;
            margin-bottom: 100px;
        }

        /* Tabs */
        .tabs { display: flex; background-color: #1e293b; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 16px 20px; border: none; background: none; color: #94a3b8; cursor: pointer; font-size: 16px; font-weight: 600; white-space: nowrap; transition: background-color 0.3s; }
        .tab-btn:hover { background-color: #334155; color: white; }
        .tab-btn.active { background-color: var(--primary-color); color: white; }

        .content-section { display: none; padding: 30px; }
        .content-section.active { display: block; }

        h2 { margin-top: 0; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; color: #334155; }

        /* Inputs */
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        input[type="text"], input[type="number"], input[type="password"], select { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; }
        
        input.task-name { flex: 1; min-width: 150px; }
        input.task-desc { flex: 2; min-width: 200px; }
        input.task-weight, input.task-target { width: 100px; }
        input.task-score { width: 80px; }
        
        input[type="date"], input[type="month"] { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: inherit; color: #334155; background: #fff; cursor: pointer; font-weight: bold; }

        /* Buttons */
        button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: opacity 0.2s; font-size: 14px; }
        button:hover { opacity: 0.9; }
        .btn-add { background-color: var(--success-color); color: white; }
        .btn-delete { background-color: var(--danger-color); color: white; padding: 5px 10px; font-size: 12px; }
        .btn-reset { background-color: #f59e0b; color: white; }
        .btn-history { background-color: var(--purple-color); color: white; }
        .btn-export { background-color: #059669; color: white; margin-bottom: 10px; }
        .btn-scheme { background-color: var(--scheme-color); color: white; margin-right: 5px; }
        .btn-create-period { background-color: #475569; color: white; margin-bottom: 20px; width: 100%; padding: 12px; border: 2px dashed #cbd5e1; font-size: 15px; }
        .btn-create-period:hover { background-color: #334155; border-color: #94a3b8; }
        .btn-create-cat { background-color: #64748b; color: white; font-size: 12px; padding: 6px 12px; }
        .btn-chart-link { background: none; border: none; color: var(--primary-color); cursor: pointer; padding: 0; font-size: 13px; text-decoration: underline; margin-left: 5px; }
        .btn-chart-link:hover { color: #1e3a8a; }

        /* Period Cards */
        .period-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; border-left: 5px solid #ccc; transition: all 0.3s ease; }
        .period-card.locked { background-color: #f8fafc; border-color: #cbd5e1; opacity: 0.95; }
        .period-card.locked input { background-color: #e2e8f0; color: #64748b; pointer-events: none; border-color: transparent; }
        .period-card.locked button.btn-delete, .period-card.locked button.btn-add { display: none; }
        .period-card.locked .input-group { display: none; }
        .period-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .period-date-title input { font-size: 18px; font-weight: bold; color: #334155; border: 1px dashed #cbd5e1; padding: 5px 10px; background: #fff; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border-color); }
        th { background-color: #f8fafc; color: #64748b; font-weight: 700; font-size: 13px; }
        td { font-size: 14px; }
        .cat-header { background-color: var(--cat-header-bg); font-weight: bold; color: #0369a1; }
        .cat-header td { border-top: 2px solid #bae6fd; padding-top: 15px; padding-bottom: 15px; }
        .cat-total-info { font-weight: normal; color: #0c4a6e; font-size: 13px; margin-left: 15px; }
        .history-row { cursor: pointer; transition: background 0.2s; }
        .history-row:hover { background-color: #eff6ff; }
        .detail-row { display: none; background-color: #f8fafc; }
        .detail-row.show { display: table-row; }
        .sub-table { width: 100%; font-size: 13px; background: white; border: 1px solid #e2e8f0; margin-top: 5px; margin-bottom: 10px; }
        .sub-table th { background: #e2e8f0; color: #475569; }

        .score-board { margin-top: 15px; padding: 20px; background-color: #eff6ff; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #bfdbfe; }
        .total-score { font-size: 24px; font-weight: bold; color: var(--primary-color); }
        
        .top-toolbar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .toolbar-group { display: flex; align-items: center; gap: 8px; }

        /* Modals & Charts */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 950px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; }
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: #666; }
        .chart-container { width: 100%; height: 300px; margin: 20px 0; background: #fdfdfd; border: 1px solid #eee; border-radius: 8px; display: block; }
        svg { width: 100%; height: 100%; }
        .chart-line { fill: none; stroke: var(--primary-color); stroke-width: 3; stroke-linejoin: round; stroke-linecap: round; }
        .chart-dot { fill: white; stroke: var(--primary-color); stroke-width: 2; cursor: pointer; }
        .chart-grid { stroke: #e5e7eb; stroke-width: 1; stroke-dasharray: 4; }
        .chart-tooltip-text { font-size: 12px; font-weight: bold; fill: #333; }

        #mid .period-card { border-left-color: var(--mid-color); }
        #long .period-card { border-left-color: var(--long-color); }
        #super-long .period-card { border-left-color: var(--sl-color); }
        #life .period-card { border-left-color: var(--life-color); }

        /* AI Chat Button (Capsule) */
        .ai-float-btn { position: fixed; bottom: 30px; right: 30px; width: auto; height: 50px; padding: 0 20px; background: linear-gradient(135deg, #2563eb, #7c3aed); border-radius: 50px; box-shadow: 0 4px 15px rgba(37,99,235,0.4); cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; color: white; z-index: 2000; transition: transform 0.2s; }
        .ai-float-btn:hover { transform: scale(1.1); }
        
        .chat-window { display: none; position: fixed; bottom: 100px; right: 30px; width: 400px; height: 650px; max-height: 80vh; background: white; border-radius: 12px; box-shadow: 0 5px 30px rgba(0,0,0,0.2); z-index: 2000; flex-direction: column; overflow: hidden; border: 1px solid #e2e8f0; }
        .chat-header { background: linear-gradient(135deg, #2563eb, #7c3aed); padding: 15px; color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-settings-btn { background: #ef4444; color: white; padding: 5px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; border: 1px solid #b91c1c; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f8fafc; font-size: 14px; }
        .chat-footer { padding: 15px; border-top: 1px solid #eee; background: white; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; resize: none; height: 45px; font-family: inherit; }
        .chat-send { background: var(--primary-color); color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .msg { margin-bottom: 12px; max-width: 85%; line-height: 1.6; padding: 12px; border-radius: 8px; word-wrap: break-word; white-space: pre-wrap; }
        .msg.user { background: #dbeafe; color: #1e3a8a; align-self: flex-end; margin-left: auto; }
        .msg.ai { background: white; border: 1px solid #e2e8f0; color: #334155; align-self: flex-start; }
        .msg.system { font-size: 12px; color: #94a3b8; text-align: center; max-width: 100%; background: none; border: none; }
        .copy-btn { display: inline-block; margin-top: 10px; font-size: 12px; color: var(--primary-color); cursor: pointer; border: 1px solid #bfdbfe; padding: 4px 10px; border-radius: 4px; background: #fff; transition: all 0.2s; }
        .copy-btn:hover { background-color: #eff6ff; }
        .config-panel { padding: 20px; background: #fff; border-bottom: 1px solid #eee; display: none; }
        .config-panel.show { display: block; }
        .config-input { width: 100%; margin-bottom: 15px; box-sizing: border-box; padding: 10px; }
        .config-label { font-size: 12px; margin-bottom: 5px; color: #475569; font-weight: bold; display: block; }
/* ==================== æ–°å¢æ ·å¼ (v32) ==================== */
        /* èŠå¤©è®°å½•åŠ è½½æç¤º */
        .chat-loading-history {
            text-align: center;
            font-size: 12px;
            color: #94a3b8;
            padding: 10px;
            display: none; /* é»˜è®¤éšè— */
        }
        
        /* å›¾è¡¨ç¿»é¡µæ§åˆ¶æ  */
        .chart-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
            background: #f8fafc;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .btn-chart-nav {
            background: white;
            border: 1px solid #cbd5e1;
            color: #334155;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-chart-nav:hover { background: #f1f5f9; color: var(--primary-color); }
        .btn-chart-nav:disabled { color: #ccc; cursor: not-allowed; background: #f9f9f9; border-color: #eee; }
        .chart-page-info { font-size: 12px; color: #64748b; font-weight: bold; }
	/* ================= v33.0 æ—¶é—´æ§åˆ¶å°æ ·å¼ ================= */
        /* å·¦ä¸‹è§’æ‚¬æµ®æŒ‰é’® */
        .time-float-btn {
            position: fixed;
            bottom: 30px;
            left: 30px; /* å·¦ä¸‹è§’ */
            height: 50px;
            padding: 0 20px;
            background: linear-gradient(135deg, #f59e0b, #d97706); /* æ©™è‰²ç³»ï¼ŒåŒºåˆ«äºAI */
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
            color: white;
            z-index: 2000;
            transition: transform 0.2s;
        }
        .time-float-btn:hover { transform: scale(1.1); }

        /* æ—¶é—´æ§åˆ¶å°çª—å£ */
        .time-window {
            display: none;
            position: fixed;
            bottom: 100px;
            left: 30px; /* å·¦ä¾§å¼¹å‡º */
            width: 500px; /* ç¨å¾®å®½ä¸€ç‚¹æ”¾å›¾è¡¨ */
            max-height: 80vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.2);
            z-index: 2000;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .time-header {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            padding: 15px;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .time-body { padding: 20px; overflow-y: auto; }
        
        /* è§†å›¾åˆ‡æ¢ Tabs */
        .view-tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .view-tab { 
            flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #64748b; font-size: 14px; font-weight: bold;
            transition: background 0.2s;
        }
        .view-tab.active { color: #d97706; border-bottom: 2px solid #d97706; background: #fffbeb; }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stat-grid { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-card { flex: 1; padding: 10px; border-radius: 8px; text-align: center; color: white; }
        .stat-card.ent { background: #ef4444; }
        .stat-card.rew { background: #10b981; }
        .stat-card.net { background: #2563eb; }
        .stat-val { font-size: 18px; font-weight: bold; margin-top: 5px; }
        .stat-label { font-size: 12px; opacity: 0.9; }
    </style>
</head>
<body>

<div class="container">
    <nav class="tabs">
        <button class="tab-btn active" onclick="switchTab('daily')">æ¯æ—¥ KPI</button>
        <button class="tab-btn" onclick="switchTab('mid')">ä¸­æœŸ KPI</button>
        <button class="tab-btn" onclick="switchTab('long')">é•¿æœŸ KPI</button>
        <button class="tab-btn" onclick="switchTab('super-long')">è¶…é•¿æœŸ KPI</button>
        <button class="tab-btn" onclick="switchTab('life')">äººç”Ÿè§„åˆ’</button>
    </nav>

    <div id="daily" class="content-section active">
        <div class="top-toolbar">
            <div class="toolbar-group">
                <h2 style="margin:0; border:none; padding:0; margin-right: 15px; color: var(--primary-color);">æ¯æ—¥ KPI</h2>
                <button class="btn-scheme" onclick="saveCurrentAsScheme()">ğŸ’¾ å­˜ä¸ºæ–¹æ¡ˆ</button>
                <button class="btn-scheme" onclick="openSchemeModal()">ğŸ“‚ æ–¹æ¡ˆåº“</button>
            </div>
            <div class="toolbar-group">
                <button class="btn-history" onclick="openHistoryModal('daily')">ğŸ“Š å†å²æ¡£æ¡ˆ (æ— é™)</button>
		<div style="margin-bottom:10px; display:flex; gap:10px;">
    <input type="number" id="dailyEnt" placeholder="å¨±ä¹æ¶ˆè€—" 
           oninput="localStorage.setItem('temp_dailyEnt', this.value)"
           style="width:100px; padding:8px; border:1px solid #cbd5e1; border-radius:4px; font-weight:bold; color:#ef4444;">
           
    <input type="number" id="dailyRew" placeholder="å¥–åŠ±è·å¾—" 
           oninput="localStorage.setItem('temp_dailyRew', this.value)"
           style="width:100px; padding:8px; border:1px solid #cbd5e1; border-radius:4px; font-weight:bold; color:#10b981;">
</div>
                <span style="font-size:14px; color:#64748b;">å­˜æ¡£æ—¥æœŸ:</span>
                <input type="date" id="kpiDate">
                <button class="btn-reset" onclick="archiveAndResetDay()">ğŸ’¾ ç»“æŸä»Šæ—¥å¹¶å­˜æ¡£</button>
            </div>
        </div>
        
        <div style="margin-bottom: 15px; padding: 15px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; gap: 15px; border: 1px solid #e2e8f0;">
            <span style="font-weight: bold; font-size: 14px; color: #475569;">åˆ†ç±»ç®¡ç†:</span>
            <button class="btn-create-cat" onclick="createCategory()">+ æ–°å»ºåˆ†ç±»</button>
            <span style="font-size: 12px; color: #94a3b8;">(åˆ é™¤åˆ†ç±»ä¼šåŒæ—¶åˆ é™¤è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¡¹ç›®)</span>
        </div>

        <div class="input-group">
            <div style="display:flex; flex-direction:column; gap:5px;">
                <label style="font-size:12px; color:#666;">é€‰æ‹©åˆ†ç±»</label>
                <select id="newDailyCat" style="min-width: 150px;"></select>
            </div>
            <div style="display:flex; flex-direction:column; gap:5px; flex:1;">
                <label style="font-size:12px; color:#666;">é¡¹ç›®åç§°</label>
                <input type="text" id="newDailyName" class="task-name" placeholder="ä¾‹å¦‚ï¼šå¥èº«">
            </div>
            <div style="display:flex; flex-direction:column; gap:5px; flex:2;">
                <label style="font-size:12px; color:#666;">å…·ä½“è¦æ±‚</label>
                <input type="text" id="newDailyDesc" class="task-desc" placeholder="ä¾‹å¦‚ï¼š30åˆ†é’Ÿ">
            </div>
            <div style="display:flex; flex-direction:column; gap:5px;">
                <label style="font-size:12px; color:#666;">æƒé‡(%)</label>
                <input type="number" id="newDailyWeight" class="task-weight" placeholder="0-100" step="0.1" min="0">
            </div>
            <div style="display:flex; flex-direction:column; justify-content:flex-end;">
                <button class="btn-add" onclick="addDailyItem()">æ·»åŠ é¡¹ç›®</button>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width:20%">é¡¹ç›®åç§°</th>
                    <th style="width:30%">å…·ä½“è¦æ±‚</th>
                    <th style="width:10%">æƒé‡</th>
                    <th style="width:15%">å®Œæˆåº¦ (0-100+)</th>
                    <th style="width:10%">åŠ æƒå¾—åˆ†</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="dailyList"></tbody>
        </table>

        <div class="score-board">
            <div>å½“å‰æ€»æƒé‡: <span id="totalWeightDisplay">0</span>% <span id="weightWarning" class="weight-warning" style="display:none; color:red; margin-left:10px;">(æ³¨æ„ï¼šæœªè¾¾100%)</span></div>
            <div class="total-score">ä»Šæ—¥æ€»åˆ†: <span id="finalScoreDisplay">0.0</span></div>
        </div>
    </div>

    <div id="mid" class="content-section">
        <div class="top-toolbar">
            <h2 style="margin:0; border:none; color: var(--mid-color);">ä¸­æœŸ KPI (ä¸¤å‘¨èŠ‚ç‚¹)</h2>
            <button class="btn-history" onclick="openHistoryModal('mid')">ğŸ“Š å†å²æ¡£æ¡ˆ</button>
        </div>
        <button class="btn-create-period" onclick="createNewPeriod('mid')">+ åˆ›å»ºæ–°çš„ä¸­æœŸç»“æŸèŠ‚ç‚¹</button>
        <div id="midPeriodsContainer"></div>
    </div>

    <div id="long" class="content-section">
        <div class="top-toolbar">
            <h2 style="margin:0; border:none; color: var(--long-color);">é•¿æœŸ KPI (ä¸¤æœˆ/å­£åº¦èŠ‚ç‚¹)</h2>
            <button class="btn-history" onclick="openHistoryModal('long')">ğŸ“Š å†å²æ¡£æ¡ˆ</button>
        </div>
        <button class="btn-create-period" onclick="createNewPeriod('long')">+ åˆ›å»ºæ–°çš„é•¿æœŸç»“æŸèŠ‚ç‚¹</button>
        <div id="longPeriodsContainer"></div>
    </div>

    <div id="super-long" class="content-section">
        <div class="top-toolbar">
            <h2 style="margin:0; border:none; color: var(--sl-color);">è¶…é•¿æœŸ KPI (åŠå¹´èŠ‚ç‚¹)</h2>
            <button class="btn-history" onclick="openHistoryModal('super-long')">ğŸ“Š å†å²æ¡£æ¡ˆ</button>
        </div>
        <button class="btn-create-period" onclick="createNewPeriod('super-long')">+ åˆ›å»ºæ–°çš„è¶…é•¿æœŸç»“æŸèŠ‚ç‚¹</button>
        <div id="super-longPeriodsContainer"></div>
    </div>

    <div id="life" class="content-section">
        <div class="top-toolbar">
            <h2 style="margin:0; border:none; color: var(--life-color);">äººç”Ÿè§„åˆ’ (5å¹´è®¡åˆ’)</h2>
            <button class="btn-history" onclick="openHistoryModal('life')">ğŸ“Š å†å²æ¡£æ¡ˆ</button>
        </div>
        <button class="btn-create-period" onclick="createNewPeriod('life')">+ åˆ›å»ºæ–°çš„äººç”Ÿè§„åˆ’èŠ‚ç‚¹</button>
        <div id="lifePeriodsContainer"></div>
    </div>

</div>

<div class="ai-float-btn" onclick="toggleChatWindow()">ğŸ¤– AI</div>

<div class="chat-window" id="chatWindow">
    <div class="chat-header">
        <span>AI äººç”Ÿæ•™ç»ƒ</span>
        <span class="chat-settings-btn" onclick="toggleConfigPanel()">âš™ï¸ APIè®¾ç½®</span>
    </div>
    
    <div class="config-panel" id="configPanel">
        <div class="config-label">Base URL (æ¥å£åœ°å€)</div>
        <input type="text" id="apiHost" class="config-input" placeholder="ä¾‹å¦‚: https://dashscope.aliyuncs.com/compatible-mode/v1">
        <div class="config-label">æ¨¡å‹åç§° (Model)</div>
        <input type="text" id="apiModel" class="config-input" placeholder="ä¾‹å¦‚: qwen-plus, qwen-turbo">
        <div class="config-label">API Key</div>
        <input type="password" id="apiKey" class="config-input" placeholder="sk-...">
        <button onclick="saveApiConfig()" style="width:100%; background:var(--success-color); color:white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold;">ä¿å­˜é…ç½®</button>
    </div>

    <div class="chat-body" id="chatBody">
        <div class="msg system" style="border-bottom: 1px dashed #cbd5e1; padding-bottom: 10px; margin-bottom: 15px;">
            <strong style="color: #d97706;">âš ï¸ æ¸©é¦¨æç¤ºï¼š</strong><br>
            ç³»ç»ŸåŠ è½½å†å²å¯¹è¯å¯èƒ½æœ‰æ—¶å»¶<br>
            ------------------------------------------------<br>
            æ¬¢è¿ï¼è¯·å…ˆç‚¹å‡»å³ä¸Šè§’çº¢è‰²â€œAPIè®¾ç½®â€æŒ‰é’®é…ç½®ã€‚<br>
            æˆ‘ä¼šè¯»å–æ‚¨çš„åˆ†ç±»ã€æƒé‡å’Œå†å²è¶‹åŠ¿è¿›è¡Œåˆ†æã€‚
        </div>
    </div>
    <div class="chat-footer">
        <textarea id="chatInput" class="chat-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea>
        <button class="chat-send" onclick="sendToAI()">å‘é€</button>
    </div>
</div>

<div id="genericHistoryModal" class="modal-overlay" onclick="closeGenericHistoryModal(event)">
    <div class="modal-content">
        <span class="close-modal" onclick="document.getElementById('genericHistoryModal').style.display='none'">&times;</span>
        <h2 id="historyModalTitle">å†å²è®°å½• (æ— é™å­˜æ¡£)</h2>
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            <p id="historySubtitle" style="color:#666; font-size:14px;">ä¸Šæ–¹ä¸ºæ€»åˆ†èµ°åŠ¿ã€‚ç‚¹å‡»åˆ†ç±»æˆ–é¡¹ç›®åç§°å¯æŸ¥çœ‹ç»†åˆ†è¶‹åŠ¿ã€‚</p>
            <button class="btn-export" id="btnExportHistory">ğŸ“¥ å¯¼å‡ºExcelæ•°æ®</button>
        </div>
        <div class="chart-container" id="genericChartContainer"></div>
	<div class="chart-container" id="timeChartContainer" style="display:none; border-top:3px solid #e2e8f0; margin-top:30px;"></div>
        <table id="genericHistoryTable" style="margin-top:20px;">
            <thead>
                <tr>
                    <th>å­˜æ¡£æ—¶é—´ (èŠ‚ç‚¹)</th>
                    <th>çŠ¶æ€</th>
                    <th id="historyScoreHeader">æ€»å¾—åˆ†</th>
                    <th style="text-align:right;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="genericHistoryList"></tbody>
        </table>
    </div>
</div>

<div id="schemeModal" class="modal-overlay" onclick="closeSchemeModal(event)">
    <div class="modal-content">
        <span class="close-modal" onclick="document.getElementById('schemeModal').style.display='none'">&times;</span>
        <h2>æ–¹æ¡ˆåº“</h2>
        <p style="color:#666; font-size:13px; margin-bottom:15px;">ç‚¹å‡»â€œåº”ç”¨â€å°†è¦†ç›–å½“å‰æ¯æ—¥KPIçš„æ‰€æœ‰åˆ†ç±»å’Œé¡¹ç›®ã€‚</p>
        <table id="schemeTable">
            <thead>
                <tr>
                    <th style="width:20%">æ–¹æ¡ˆåç§°</th>
                    <th style="width:60%">åŒ…å«åˆ†ç±»/é¡¹ç›®è¯¦æƒ…</th>
                    <th style="text-align:right; width:20%">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="schemeList"></tbody>
        </table>
    </div>
</div>

<script>
    /* script.js - ä¸ªäººäººç”ŸKPIç³»ç»Ÿ v31.0 (IndexedDB æ— é™å­˜å‚¨ç‰ˆ) */

    // ==========================================
    // 1. IndexedDB é€‚é…å™¨ (æ— é™å­˜å‚¨æ ¸å¿ƒ)
    // ==========================================
    const DB_CONFIG = { name: 'LifeKPI_Unlimited_DB', version: 1, storeName: 'appDataStore' };
    const DATA_KEY = 'main_app_data'; 

    const IDB = {
        db: null,
        init: function() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(DB_CONFIG.storeName)) {
                        db.createObjectStore(DB_CONFIG.storeName);
                    }
                };
                req.onsuccess = (e) => {
                    this.db = e.target.result;
                    resolve(this.db);
                };
                req.onerror = (e) => reject(e);
            });
        },
        save: function(data) {
            if (!this.db) return;
            const tx = this.db.transaction([DB_CONFIG.storeName], 'readwrite');
            tx.objectStore(DB_CONFIG.storeName).put(data, DATA_KEY);
        },
        load: function() {
            return new Promise((resolve, reject) => {
                if (!this.db) return resolve(null);
                const tx = this.db.transaction([DB_CONFIG.storeName], 'readonly');
                const req = tx.objectStore(DB_CONFIG.storeName).get(DATA_KEY);
                req.onsuccess = (e) => resolve(e.target.result);
                req.onerror = (e) => reject(e);
            });
        }
    };

    // ==========================================
    // 2. åº”ç”¨ä¸»é€»è¾‘
    // ==========================================
    const OLD_STORAGE_KEY = 'life_system_data_v23'; 
    const API_CONFIG_KEY = 'life_system_api_config';

    let appData = {
        dailyCategories: [], dailyItems: [], dailyHistory: [], schemes: [],
        midPeriods: [], midHistory: [],
        longPeriods: [], longHistory: [],
        superLongPeriods: [], superLongHistory: [],
        lifePeriods: [], lifeHistory: [],
        chatHistory: []
    };

    function getPropName(type, suffix) {
        if (type === 'super-long') return 'superLong' + suffix;
        return type + suffix;
    }

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ”¹ä¸ºå¼‚æ­¥åŠ è½½ï¼Œå¹¶åŒ…å«è¿ç§»é€»è¾‘ â˜…â˜…â˜…
    async function loadData() {
        await IDB.init(); // åˆå§‹åŒ– IndexedDB
        
        // 1. å°è¯•ä» IndexedDB åŠ è½½
        const dbData = await IDB.load();
        
        if (dbData) {
            appData = { ...appData, ...dbData };
        } else {
            // 2. ç¬¬ä¸€æ¬¡è¿è¡Œï¼šä»æ—§ LocalStorage è¿ç§»æ•°æ®
            const oldData = localStorage.getItem(OLD_STORAGE_KEY);
            if (oldData) {
                console.log("æ­£åœ¨ä» LocalStorage è¿ç§»æ•°æ®åˆ° IndexedDB...");
                const parsed = JSON.parse(oldData);
                if (parsed.history && !parsed.dailyHistory) parsed.dailyHistory = parsed.history;
                appData = { ...appData, ...parsed };
                saveData(); 
            }
        }

        // åˆå§‹åŒ–é»˜è®¤åˆ†ç±»
        const DEFAULT_CAT_NAME = "é»˜è®¤åˆ†ç±»ï¼ˆç”¨æˆ·å¯åˆ é™¤ï¼‰";
        if (!appData.dailyCategories || appData.dailyCategories.length === 0) {
            const defId = Date.now();
            appData.dailyCategories = [{ id: defId, name: DEFAULT_CAT_NAME }];
            if(appData.dailyItems.length > 0) appData.dailyItems.forEach(i => { if(!i.catId) i.catId = defId; });
        }

        // åŠ è½½ API é…ç½®
        const apiConfig = JSON.parse(localStorage.getItem(API_CONFIG_KEY) || '{}');
        document.getElementById('apiHost').value = apiConfig.host || 'https://dashscope.aliyuncs.com/compatible-mode/v1';
        document.getElementById('apiModel').value = apiConfig.model || 'qwen-plus';
        document.getElementById('apiKey').value = apiConfig.key || '';

        // æ¸²æŸ“ç•Œé¢
        renderDailyTable();
        renderPeriods('mid'); renderPeriods('long'); renderPeriods('super-long'); renderPeriods('life');
        
        const now = new Date();
        const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        document.getElementById('kpiDate').value = localDate;
        
        if(appData.chatHistory && appData.chatHistory.length > 0) renderChatHistory();
    }

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜åˆ° IndexedDB â˜…â˜…â˜…
    function saveData() { 
        IDB.save(appData); 
    }

    function switchTab(tabId) {
        document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const tabs = ['daily', 'mid', 'long', 'super-long', 'life'];
        document.querySelectorAll('.tab-btn')[tabs.indexOf(tabId)].classList.add('active');
    }

    // ... (æ ‡å‡†åŠŸèƒ½å‡½æ•°) ...
    function createCategory() {
        const name = prompt("è¯·è¾“å…¥æ–°åˆ†ç±»åç§°:");
        if(!name) return;
        appData.dailyCategories.push({ id: Date.now(), name: name });
        saveData(); renderDailyTable();
    }

    function deleteCategory(catId) {
        const cat = appData.dailyCategories.find(c => c.id === catId);
        if(appData.dailyCategories.length === 1) return alert("å¿…é¡»ä¿ç•™è‡³å°‘ä¸€ä¸ªåˆ†ç±»ã€‚");
        if(confirm(`è­¦å‘Šï¼šç¡®å®šåˆ é™¤åˆ†ç±»ã€${cat.name}ã€‘å—ï¼Ÿ\n\næ³¨æ„ï¼šè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¡¹ç›®ä¹Ÿå°†è¢«æ°¸ä¹…åˆ é™¤ï¼`)) {
            appData.dailyItems = appData.dailyItems.filter(i => i.catId !== catId);
            appData.dailyCategories = appData.dailyCategories.filter(c => c.id !== catId);
            saveData(); renderDailyTable();
        }
    }

    function renameCategory(catId) {
        const cat = appData.dailyCategories.find(c => c.id === catId);
        const newName = prompt("é‡å‘½ååˆ†ç±»:", cat.name);
        if(newName) { cat.name = newName; saveData(); renderDailyTable(); }
    }

    function addDailyItem() {
        const catId = parseInt(document.getElementById('newDailyCat').value);
        const name = document.getElementById('newDailyName').value.trim();
        const desc = document.getElementById('newDailyDesc').value.trim();
        const weight = parseFloat(document.getElementById('newDailyWeight').value);
        if (!catId) return alert("è¯·å…ˆåˆ›å»ºå¹¶é€‰æ‹©ä¸€ä¸ªåˆ†ç±»");
        if (!name || isNaN(weight)) return alert('è¯·è¾“å…¥æ­£ç¡®ä¿¡æ¯');
        appData.dailyItems.push({ id: Date.now(), catId, name, desc, weight, score: 0 });
        ['newDailyName','newDailyDesc','newDailyWeight'].forEach(id=>document.getElementById(id).value='');
        saveData(); renderDailyTable();
    }

    function deleteDailyItem(id) {
        if(confirm('åˆ é™¤æ­¤é¡¹ç›®ï¼Ÿ')) { appData.dailyItems = appData.dailyItems.filter(i => i.id !== id); saveData(); renderDailyTable(); }
    }

    function updateDailyScore(id, val) {
        let score = parseFloat(val); if (isNaN(score) || score < 0) score = 0;
        const item = appData.dailyItems.find(i => i.id === id);
        if(item) { item.score = score; saveData(); renderDailyTable(); } 
    }

    function changeItemCategory(itemId, newCatId) {
        const item = appData.dailyItems.find(i => i.id === itemId);
        if(item) { item.catId = parseInt(newCatId); saveData(); renderDailyTable(); }
    }

    function renderDailyTable() {
        const catSelect = document.getElementById('newDailyCat');
        const currentSel = catSelect.value;
        catSelect.innerHTML = appData.dailyCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        if(currentSel && appData.dailyCategories.some(c=>c.id==currentSel)) catSelect.value = currentSel;

        const tbody = document.getElementById('dailyList'); tbody.innerHTML = '';
        let totalWeight = 0; let totalScore = 0;

        appData.dailyCategories.forEach(cat => {
            const items = appData.dailyItems.filter(i => i.catId === cat.id);
            let catWeight = 0; let catScore = 0;
            items.forEach(i => { catWeight += i.weight; catScore += (i.score * (i.weight / 100)); });
            totalWeight += catWeight; totalScore += catScore;

            tbody.innerHTML += `
                <tr class="cat-header">
                    <td colspan="6">
                        <span>ğŸ“‚ ${cat.name}</span>
                        <span class="cat-total-info">(è¯¥ç±»æ€»æƒé‡: ${catWeight.toFixed(1)}% | è´¡çŒ®æ€»åˆ†: ${catScore.toFixed(2)})</span>
                        <div style="float:right;">
                            <button style="background:none; color:#2563eb; border:none; padding:0 5px;" onclick="renameCategory(${cat.id})">é‡å‘½å</button>
                            <button style="background:none; color:#dc2626; border:none; padding:0 5px;" onclick="deleteCategory(${cat.id})">åˆ é™¤åˆ†ç±»</button>
                        </div>
                    </td>
                </tr>`;
            items.forEach(item => {
                const weightedScore = (item.score * (item.weight / 100)).toFixed(2);
                const catOptions = appData.dailyCategories.map(c => `<option value="${c.id}" ${c.id === item.catId ? 'selected' : ''}>${c.name}</option>`).join('');
                tbody.innerHTML += `
                    <tr>
                        <td style="padding-left: 25px;">${item.name}</td>
                        <td style="font-size:12px; color:#666;">${item.desc || '-'}</td>
                        <td>${item.weight.toFixed(1)}%</td>
                        <td><input type="number" value="${item.score}" class="task-score" onchange="updateDailyScore(${item.id}, this.value)"></td>
                        <td>${weightedScore}</td>
                        <td>
                            <select style="width:90px; padding:2px; font-size:11px; margin-right:5px;" onchange="changeItemCategory(${item.id}, this.value)">${catOptions}</select>
                            <button class="btn-delete" onclick="deleteDailyItem(${item.id})">åˆ é™¤</button>
                        </td>
                    </tr>`;
            });
        });
        document.getElementById('totalWeightDisplay').innerText = totalWeight.toFixed(1);
        document.getElementById('weightWarning').style.display = Math.abs(totalWeight - 100) > 0.1 ? 'inline' : 'none';
        document.getElementById('finalScoreDisplay').innerText = totalScore.toFixed(2);
    }

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ— é™åˆ¶å­˜æ¡£ (Daily) â˜…â˜…â˜…
    function archiveAndResetDay() {
        const score = document.getElementById('finalScoreDisplay').innerText;
        const dateInput = document.getElementById('kpiDate').value;
        const entTime = parseFloat(document.getElementById('dailyEnt').value) || 0;
        const rewTime = parseFloat(document.getElementById('dailyRew').value) || 0;

        if (!dateInput) return alert("è¯·é€‰æ‹©æ—¥æœŸ");
        if (!confirm(`ç¡®è®¤å­˜æ¡£æ¯æ—¥KPIï¼Ÿ\n\næ—¥æœŸï¼š${dateInput}\nä»Šæ—¥æ€»åˆ†ï¼š${score}\nå¨±ä¹æ¶ˆè€—ï¼š${entTime}\nå¥–åŠ±è·å¾—ï¼š${rewTime}`)) return;
        
        appData.dailyHistory.push({ 
            date: dateInput, 
            periodName: 'Daily', 
            score: parseFloat(score), 
            timestamp: new Date(dateInput).getTime(), 
            entertainmentTime: entTime,
            rewardTime: rewTime,
            items: JSON.parse(JSON.stringify(appData.dailyItems)), 
            categories: JSON.parse(JSON.stringify(appData.dailyCategories))
        });
        
        appData.dailyHistory.sort((a,b) => b.timestamp - a.timestamp);

        let c = parseInt(localStorage.getItem('daily_archive_count_v30') || '0') + 1;
        localStorage.setItem('daily_archive_count_v30', c);
        if (c % 30 === 0) if(confirm(`å·²ç´¯è®¡å­˜æ¡£ ${c} æ¬¡ã€‚æ˜¯å¦å¯¼å‡ºå¤‡ä»½ï¼Ÿ`)) exportToCSV('daily'); 

        appData.dailyItems.forEach(i => i.score = 0);
        
        // æ¸…ç©ºè¾“å…¥æ¡†å’Œç¼“å­˜
        document.getElementById('dailyEnt').value = '';
        document.getElementById('dailyRew').value = '';
        localStorage.removeItem('temp_dailyEnt');
        localStorage.removeItem('temp_dailyRew');

        saveData(); renderDailyTable();
        alert("å·²å­˜æ¡£");
    }

    // ... (Schemes - Standard) ...
    function saveCurrentAsScheme() {
        if(appData.dailyItems.length===0) return alert("ç©ºåˆ—è¡¨");
        const name = prompt("æ–¹æ¡ˆå:"); if(!name) return;
        appData.schemes.push({
            id:Date.now(), name, 
            items: JSON.parse(JSON.stringify(appData.dailyItems)),
            categories: JSON.parse(JSON.stringify(appData.dailyCategories))
        }); 
        saveData(); alert("ä¿å­˜æˆåŠŸ");
    }
    function openSchemeModal() { 
        document.getElementById('schemeModal').style.display='flex'; 
        const t = document.getElementById('schemeList'); t.innerHTML='';
        appData.schemes.forEach((s, i) => {
            let details = s.categories ? "åŒ…å«åˆ†ç±»ä¿¡æ¯" : s.items.map(it => it.name).join(', ');
            t.innerHTML += `<tr><td style="font-weight:bold;">${s.name}</td><td>${details}</td><td style="text-align:right;"><button class="btn-scheme" onclick="applyScheme(${i})">åº”ç”¨</button><button class="btn-delete" onclick="if(confirm('åˆ é™¤?')){appData.schemes.splice(${i},1); saveData(); openSchemeModal();}">åˆ é™¤</button></td></tr>`;
        });
    }
    function applyScheme(i) {
        if(!confirm("åº”ç”¨æ­¤æ–¹æ¡ˆå°†è¦†ç›–å½“å‰é¡¹ç›®ï¼Œç»§ç»­ï¼Ÿ")) return;
        const s = appData.schemes[i];
        appData.dailyCategories = JSON.parse(JSON.stringify(s.categories || [{id:1, name:"é»˜è®¤åˆ†ç±»"}]));
        appData.dailyItems = JSON.parse(JSON.stringify(s.items));
        appData.dailyItems.forEach(x => x.score = 0);
        saveData(); renderDailyTable(); document.getElementById('schemeModal').style.display='none';
    }
    function closeSchemeModal(e){ if(e.target.className === 'modal-overlay') document.getElementById('schemeModal').style.display='none'; }

    // ... (Period Manager - Standard) ...
    function getDefaultDate(type) {
        const now = new Date();
        const local = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
        if(type === 'life') return local.getFullYear();
        if(type === 'long' || type === 'super-long') return local.toISOString().slice(0, 7); 
        return local.toISOString().split('T')[0];
    }
    function createNewPeriod(type) {
        const key = getPropName(type, 'Periods');
        appData[key].unshift({ id: Date.now(), date: getDefaultDate(type), items: [], isArchived: false, archiveDate: null });
        saveData(); renderPeriods(type);
    }
    function deletePeriod(type, id) {
        if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
            const key = getPropName(type, 'Periods');
            const idx = appData[key].findIndex(p => p.id === id);
            if (idx > -1) { appData[key].splice(idx, 1); saveData(); renderPeriods(type); }
        }
    }
    function updatePeriodDate(type, id, val) { const key = getPropName(type, 'Periods'); appData[key].find(p => p.id === id).date = val; saveData(); }
    function addItemToPeriod(type, id) {
        const key = getPropName(type, 'Periods');
        const p = appData[key].find(p => p.id === id);
        const name = document.getElementById(`name-${id}`).value.trim();
        const desc = document.getElementById(`desc-${id}`).value.trim();
        if(!name) return alert("åç§°å¿…å¡«");
        let newItem = { id: Date.now(), name, desc, ratio: 0 };
        if (type === 'mid' || type === 'long') {
            const t = parseFloat(document.getElementById(`target-${id}`).value);
            if(isNaN(t)) return alert("è¯·è¾“å…¥ç›®æ ‡åˆ†");
            newItem.target = t; document.getElementById(`target-${id}`).value = '';
        }
        p.items.push(newItem);
        ['name','desc'].forEach(x=>document.getElementById(`${x}-${id}`).value='');
        saveData(); renderPeriods(type);
    }
    function updatePeriodItem(type, id, iIdx, field, val) {
        const key = getPropName(type, 'Periods');
        const p = appData[key].find(p => p.id === id);
        let n = parseFloat(val); if(isNaN(n)||n<0) n=0; 
        p.items[iIdx][field] = n; saveData();
        if(type==='mid'||type==='long') renderPeriods(type);
    }
    function deletePeriodItem(type, id, iIdx) {
        if(confirm("åˆ é™¤æ­¤é¡¹ç›®ï¼Ÿ")) { 
            const key = getPropName(type, 'Periods');
            appData[key].find(p => p.id === id).items.splice(iIdx, 1); saveData(); renderPeriods(type); 
        }
    }

    function archivePeriod(type, id) {
        const pKey = getPropName(type, 'Periods');
        const hKey = getPropName(type, 'History');
        const p = appData[pKey].find(p => p.id === id);
        
        if(!p.date) return alert("è¯·è®¾ç½®æ—¥æœŸ");
        
        let s = 0; if(type==='mid'||type==='long') p.items.forEach(i => s += i.target * (i.ratio/100));
        
        // 1. è¯¢é—®å¥–åŠ±
        let rewardInput = prompt(`æ­å–œå®Œæˆã€${type === 'life' ? 'äººç”Ÿ' : 'é˜¶æ®µ'}èŠ‚ç‚¹ã€‘ï¼\nè¯·è¾“å…¥è¯¥èŠ‚ç‚¹ä¸ºæ‚¨å¸¦æ¥çš„ã€å¥–åŠ±æ—¶é—´ã€‘ï¼š`, "0");
        if (rewardInput === null) return; 
        let rewardTime = parseFloat(rewardInput);
        if (isNaN(rewardTime)) rewardTime = 0;

        if(!confirm(`ç¡®è®¤ç»“ç®—èŠ‚ç‚¹ï¼š${p.date}ï¼Ÿ\nè·å¾—å¥–åŠ±æ—¶é—´ï¼š${rewardTime}`)) return;
        
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œç¡®ä¿äººç”Ÿè§„åˆ’(2025)èƒ½è¢«æ­£ç¡®è¯†åˆ« â˜…â˜…â˜…
        let ts;
        const dStr = String(p.date); // å…³é”®ï¼šåŠ äº† String()ï¼Œæ•°å­—å˜æ–‡å­—
        
        if (dStr.length === 4) { 
            // æ ¼å¼ "2025" -> å¼ºåˆ¶è®¾ä¸º 2025å¹´12æœˆ31æ—¥ 23:59:59
            const year = parseInt(dStr);
            ts = new Date(year, 11, 31, 23, 59, 59).getTime(); 
        } else if (dStr.length === 7) { 
            // æ ¼å¼ "2025-05" -> å¼ºåˆ¶è®¾ä¸ºå½“æœˆæœ€åä¸€å¤©
            const parts = dStr.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]); 
            ts = new Date(year, month, 0, 23, 59, 59).getTime();
        } else { 
            // æ ¼å¼ "2025-05-12" -> å½“å¤©
            const parts = dStr.split('-');
            ts = new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]), 23, 59, 59).getTime();
        }
        
        appData[hKey].push({
            date: p.date, 
            periodName: p.date, 
            score: (type==='mid'||type==='long') ? parseFloat(s.toFixed(2)) : 0, 
            timestamp: ts, 
            items: JSON.parse(JSON.stringify(p.items)),
            rewardTime: rewardTime
        });
        
        appData[hKey].sort((a,b) => b.timestamp - a.timestamp);
        
        let cKey = 'archive_count_' + type + '_v30';
        let c = parseInt(localStorage.getItem(cKey) || '0') + 1;
        localStorage.setItem(cKey, c);
        if (c % 10 === 0) if(confirm(`å·²ç´¯è®¡å­˜æ¡£ ${c} æ¬¡ï¼Œå¯¼å‡ºæ•°æ®ï¼Ÿ`)) exportToCSV(type);

        p.isArchived = true; p.archiveDate = p.date; 
        saveData(); renderPeriods(type);
    }
    function renderPeriods(type) {
        const containerId = type === 'super-long' ? 'super-longPeriodsContainer' : type + 'PeriodsContainer';
        const cont = document.getElementById(containerId); if(!cont) return; cont.innerHTML = '';
        const key = getPropName(type, 'Periods');
        const all = appData[key] || [];
        const active = all.filter(p => !p.isArchived);
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ˜¾ç¤ºæ‰€æœ‰å·²å½’æ¡£èŠ‚ç‚¹ï¼Œä¸å† slice(0, 7) â˜…â˜…â˜…
        const archived = all.filter(p => p.isArchived).sort((a,b) => (b.archiveDate > a.archiveDate ? 1 : -1));
        const renderList = [...active, ...archived]; // æ˜¾ç¤ºå…¨éƒ¨

        if(renderList.length === 0) { cont.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— èŠ‚ç‚¹</div>'; return; }

        renderList.forEach((p) => {
            const isL = p.isArchived; const pid = p.id;
            let clr = 'var(--primary-color)';
            if(type==='mid') clr='var(--mid-color)'; if(type==='long') clr='var(--long-color)';
            if(type==='super-long') clr='var(--sl-color)'; if(type==='life') clr='var(--life-color)';
            let hasT = (type==='mid'||type==='long');
            
            let dateHtml = isL ? `<span style="font-size:20px;font-weight:bold;color:${clr}">ğŸ“… ${p.archiveDate}</span>` : 
                `<div style="display:flex;align-items:center;"><span style="font-size:14px;margin-right:8px;color:#666;">ç›®æ ‡èŠ‚ç‚¹:</span><input type="${type==='life'?'number':(type==='long'||type==='super-long'?'month':'date')}" value="${p.date}" onchange="updatePeriodDate('${type}',${pid},this.value)" style="font-size:16px;padding:5px;border:1px solid #ccc;font-weight:bold;color:#333;"></div>`;
            
            let head = `<tr><th style="width:20%">é¡¹ç›®</th><th style="width:30%">è¦æ±‚</th>${hasT?'<th style="width:10%">ç›®æ ‡åˆ†</th>':''}<th style="width:15%">å®Œæˆ(%)</th>${hasT?'<th style="width:10%">å¾—åˆ†</th>':''}<th>æ“ä½œ</th></tr>`;
            let total = 0;
            let rows = p.items.map((i, idx) => {
                let sc = ''; if(hasT) { let s=i.target*(i.ratio/100); total+=s; sc=`<td style="font-weight:bold;">${s.toFixed(2)}</td>`; }
                return `<tr><td>${i.name}</td><td style="font-size:13px;color:#555;">${i.desc}</td>${hasT?`<td>${i.target}</td>`:''}<td><input type="number" value="${i.ratio}" class="task-score" ${isL?'disabled':''} onchange="updatePeriodItem('${type}',${pid},${idx},'ratio',this.value)"></td>${sc}<td>${!isL?`<button class="btn-delete" onclick="deletePeriodItem('${type}',${pid},${idx})">åˆ é™¤</button>`:'-'}</td></tr>`;
            }).join('');
            
            let addRow = isL ? '' : `<div class="input-group" style="background:#fff;border:none;padding:0;margin-bottom:15px;"><input type="text" id="name-${pid}" class="task-name" placeholder="åç§°"><input type="text" id="desc-${pid}" class="task-desc" placeholder="è¦æ±‚">${hasT?`<input type="number" id="target-${pid}" class="task-target" placeholder="ç›®æ ‡åˆ†">`:''}<button class="btn-add" onclick="addItemToPeriod('${type}',${pid})">æ·»åŠ </button></div>`;
            
            cont.innerHTML += `<div class="period-card ${isL?'locked':''}" style="border-left-color:${clr}"><div class="period-header"><div class="period-date-title">${dateHtml} ${isL?'<span style="font-size:12px;background:#64748b;color:white;padding:2px 6px;border-radius:4px;margin-left:10px;">å·²å½’æ¡£</span>':''}</div><div><button class="btn-delete" onclick="deletePeriod('${type}',${pid})">åˆ é™¤èŠ‚ç‚¹</button></div></div>${addRow}<table>${head}${rows}</table><div class="score-board" style="margin-top:15px;background:#f8fafc;border:1px solid #e2e8f0;">${hasT?`<div class="total-score" style="color:${clr}">æ€»åˆ†: <span id="total-${pid}">${total.toFixed(2)}</span></div>`:`<div style="color:${clr};font-weight:bold;">${isL?'æœ€ç»ˆè¿›åº¦':'å½“å‰è¿›åº¦'}</div>`}${!isL?`<button class="btn-reset" style="background-color:${clr}" onclick="archivePeriod('${type}',${pid})">ç»“ç®—å­˜æ¡£</button>`:'<span></span>'}</div></div>`;
        });
    }

    // ... (History / Charts / Export - Standard) ...
    function openHistoryModal(type) {
        document.getElementById('genericHistoryModal').style.display = 'flex';
        const chartCont = document.getElementById('genericChartContainer');
        const subtitle = document.getElementById('historySubtitle');
        chartCont.innerHTML = ''; chartCont.style.display = 'none';
        if (type === 'super-long' || type === 'life') subtitle.style.display = 'none'; else subtitle.style.display = 'block';

        const hKey = getPropName(type, 'History');
        let h = appData[hKey] || [];
        h.sort((a,b) => b.timestamp - a.timestamp);
        
        if (type === 'daily' || type === 'mid' || type === 'long') {
            chartCont.style.display = 'block';
            renderTotalScoreChart(h, type);
        }

        const tbody = document.getElementById('genericHistoryList'); tbody.innerHTML = '';
        h.forEach((rec, i) => {
            let detailHtml = '';
            if (type === 'daily') {
                if (rec.categories) {
                    rec.categories.forEach(cat => {
                        const cItems = rec.items.filter(it => it.catId === cat.id);
                        if(cItems.length > 0) {
                            const sigItems = cItems.map(x=>({name:x.name, weight:x.weight})).sort((a,b)=>a.name.localeCompare(b.name));
                            const sigJson = JSON.stringify(sigItems).replace(/"/g, '&quot;');
                            detailHtml += `<div style="background:#e0f2fe; padding:8px; margin-top:8px; font-weight:bold; color:#0369a1; border-top:1px solid #bae6fd; display:flex; justify-content:space-between;"><span>ğŸ“‚ ${cat.name}</span><button class="btn-chart-link" onclick="showCategoryTrend('${cat.name}', ${sigJson})">ğŸ“ˆ åˆ†ç±»è¶‹åŠ¿</button></div><table class="sub-table"><thead><tr><th>é¡¹ç›®</th><th>è¦æ±‚</th><th>æƒé‡</th><th>å¾—åˆ†</th></tr></thead><tbody>${cItems.map(it => `<tr><td>${it.name}<button class="btn-chart-link" onclick="showItemTrend('${it.name}', ${it.weight})">ğŸ“ˆ</button></td><td>${it.desc||'-'}</td><td>${it.weight}%</td><td>${(it.score*(it.weight/100)).toFixed(2)}</td></tr>`).join('')}</tbody></table>`;
                        }
                    });
                } else { detailHtml = `<div style="padding:10px;">æ—§æ•°æ®æ— åˆ†ç±»</div>`; }
            } else {
                let tHeader = `<th>é¡¹ç›®</th><th>è¦æ±‚</th>${(type==='mid'||type==='long')?'<th>ç›®æ ‡</th>':''}<th>å®Œæˆ</th>${(type==='mid'||type==='long')?'<th>å¾—åˆ†</th>':''}`;
                let tRows = rec.items.map(it => {
                     let scoreCol = (type==='mid'||type==='long') ? `<td>${(it.target*(it.ratio/100)).toFixed(2)}</td>` : '';
                     let targetCol = (type==='mid'||type==='long') ? `<td>${it.target}</td>` : '';
                     return `<tr><td>${it.name}</td><td>${it.desc}</td>${targetCol}<td>${it.ratio}%</td>${scoreCol}</tr>`;
                 }).join('');
                 detailHtml = `<table class="sub-table"><thead><tr>${tHeader}</tr></thead><tbody>${tRows}</tbody></table>`;
            }
            let scoreDisplay = (type === 'super-long' || type === 'life') ? '-' : `<strong>${rec.score}</strong>`;
            tbody.innerHTML += `<tr class="history-row" onclick="this.nextElementSibling.classList.toggle('show')"><td>${rec.date}</td><td><span style="background:#f1f5f9; padding:2px 6px; border-radius:4px; font-size:12px;">å·²å½’æ¡£</span></td><td>${scoreDisplay}</td><td style="text-align:right;"><button class="btn-delete" onclick="deleteHistoryItem('${type}', ${i})">åˆ é™¤</button></td></tr><tr class="detail-row"><td colspan="4" style="padding:15px; background:#fff;">${detailHtml}</td></tr>`;
        });
        document.getElementById('btnExportHistory').onclick = () => exportToCSV(type);
    }
    function closeGenericHistoryModal(e) { if(e.target.className === 'modal-overlay') document.getElementById('genericHistoryModal').style.display = 'none'; }

    // ä¿®æ”¹ï¼šå¢åŠ  type å‚æ•°ï¼Œç”Ÿæˆä¸åŒçš„æ ‡é¢˜ï¼Œå¹¶æºå¸¦æ—¶é—´æ•°æ®
    function renderTotalScoreChart(historyData, type) {
        const sorted = [...historyData].sort((a,b) => a.timestamp - b.timestamp);
        
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ˜ å°„æ•°æ®æ—¶ï¼ŒæŠŠ entertainmentTime ç­‰å¸¦ä¸Š â˜…â˜…â˜…
        const data = sorted.map(r => ({ 
            date: r.date, 
            value: r.score,
            // é™„åŠ æ•°æ® (å¦‚æœä¸å­˜åœ¨åˆ™ä¸º0)
            ent: r.entertainmentTime || 0,
            rew: r.rewardTime || 0,
            net: (r.rewardTime || 0) - (r.entertainmentTime || 0)
        }));
        
        let chartTitle = "æ€»åˆ†è¶‹åŠ¿å›¾";
        if (type === 'daily') chartTitle = "æ¯æ—¥KPI æ€»åˆ†è¶‹åŠ¿";
        else if (type === 'mid') chartTitle = "ä¸­æœŸKPI æ€»åˆ†è¶‹åŠ¿";
        else if (type === 'long') chartTitle = "é•¿æœŸKPI æ€»åˆ†è¶‹åŠ¿";

        renderChart(chartTitle, data);
    }
    function showItemTrend(targetName, targetWeight) {
        const h = appData.dailyHistory;
        const sorted = [...h].sort((a,b) => a.timestamp - b.timestamp);
        const data = sorted.map(rec => {
            const match = rec.items.find(i => i.name === targetName && Math.abs(i.weight - targetWeight) < 0.01);
            return { date: rec.date, value: match ? match.score : null }; // æ˜¾ç¤ºå®Œæˆåº¦
        });
        renderChart(`é¡¹ç›®å®Œæˆåº¦(%)è¶‹åŠ¿: ${targetName}`, data);
    }
    function showCategoryTrend(catName, sigItems) {
        const h = appData.dailyHistory;
        const sorted = [...h].sort((a,b) => a.timestamp - b.timestamp);
        const data = sorted.map(rec => {
            if(!rec.categories) return { date: rec.date, value: null };
            const cat = rec.categories.find(c => c.name === catName);
            if(!cat) return { date: rec.date, value: null };
            const items = rec.items.filter(i => i.catId === cat.id);
            if(items.length !== sigItems.length) return { date: rec.date, value: null };
            const curSig = items.map(x=>({n:x.name, w:x.weight})).sort((a,b)=>a.n.localeCompare(b.n));
            let match = true;
            for(let k=0; k<sigItems.length; k++) { if(sigItems[k].name !== curSig[k].n || Math.abs(sigItems[k].weight - curSig[k].w) > 0.01) { match=false; break; } }
            if(match) {
                let totalWeightedScore = 0; let totalWeight = 0;
                items.forEach(i => { totalWeightedScore += (i.score * (i.weight/100)); totalWeight += i.weight; });
                return { date: rec.date, value: totalWeight===0?0:(totalWeightedScore/totalWeight)*100 };
            }
            return { date: rec.date, value: null };
        });
        renderChart(`åˆ†ç±»å®Œæˆåº¦(%)è¶‹åŠ¿: ${catName}`, data);
    }
// ==================== å›¾è¡¨åˆ†é¡µæ ¸å¿ƒé€»è¾‘ (ä¿®å¤ç‰ˆ) ====================
let chartGlobalState = {
    title: '',
    data: [],
    page: 0,   // 0 = æœ€æ–°çš„æ•°æ®é¡µ
    pageSize: 7 // ä¿®æ”¹ä¸ºç”¨æˆ·è¦æ±‚çš„ 7 å¤©
};

function renderChart(title, data) {
    // åªæœ‰å½“æ ‡é¢˜æ”¹å˜æ—¶ï¼ˆæ¯”å¦‚ä»â€œæ€»åˆ†â€åˆ‡æ¢åˆ°â€œåˆ†ç±»è¶‹åŠ¿â€ï¼‰ï¼Œæ‰é‡ç½®é¡µç ä¸º0
    if (title !== chartGlobalState.title) {
        chartGlobalState.title = title;
        chartGlobalState.page = 0;
        chartGlobalState.data = data; // ç¼“å­˜å®Œæ•´æ•°æ®
    }
    
    const cont = document.getElementById('genericChartContainer');
    cont.style.display = 'block'; 
    cont.innerHTML = '';

    // è¿‡æ»¤æ— æ•ˆæ•°æ®å¹¶å…‹éš†ä¸€ä»½é˜²æ­¢æ±¡æŸ“
    const validData = chartGlobalState.data.filter(d => d.value !== null);
    
    if(validData.length === 0) { 
        cont.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">${title}<br>æ— æœ‰æ•ˆæ•°æ®</div>`; 
        return; 
    }

    const totalLen = validData.length;
    
    // --- æ ¸å¿ƒä¿®å¤ï¼šè®¡ç®—åˆ†é¡µè¾¹ç•Œ ---
    const maxPage = Math.max(0, Math.ceil(totalLen / chartGlobalState.pageSize) - 1);
    if (chartGlobalState.page > maxPage) chartGlobalState.page = maxPage;
    if (chartGlobalState.page < 0) chartGlobalState.page = 0;

    // è®¡ç®—åˆ‡ç‰‡èŒƒå›´ (æ³¨æ„ï¼šè¿™æ˜¯ä»åå¾€å‰åˆ‡ï¼Œå³ page 0 æ˜¯æœ€åï¼ˆæœ€æ–°ï¼‰çš„ pageSize æ¡)
    const end = totalLen - (chartGlobalState.page * chartGlobalState.pageSize);
    const start = Math.max(0, end - chartGlobalState.pageSize);
    const pageData = validData.slice(start, end);

    // æŒ‰é’®çŠ¶æ€åˆ¤å®š
    const canGoPrev = start > 0;      // è¿˜æœ‰æ›´æ—©çš„æ•°æ®
    const canGoNext = end < totalLen; // è¿˜å¯ä»¥å¾€â€œæ›´æ–°â€çš„æ–¹å‘èµ°

    // æ¸²æŸ“æ§åˆ¶æ 
    cont.innerHTML = `
        <div class="chart-controls">
            <button class="btn-chart-nav" ${canGoPrev ? '' : 'disabled'} onclick="changeChartPage(1)">â¬…ï¸ æ›´æ—©</button>
            <div style="text-align:center;">
                <div style="font-weight:bold; color:#333;">${title}</div>
                <div class="chart-page-info">
                    ç¬¬ ${chartGlobalState.page + 1} é¡µ / å…± ${maxPage + 1} é¡µ 
                    (${pageData[0].date.slice(5)} ~ ${pageData[pageData.length-1].date.slice(5)})
                </div>
            </div>
            <button class="btn-chart-nav" ${canGoNext ? '' : 'disabled'} onclick="changeChartPage(-1)">æ›´æ–° â¡ï¸</button>
        </div>
    `;

    if (pageData.length === 0) return;

    // --- ç»˜å›¾é€»è¾‘ä¿æŒä¸å˜ï¼Œä½†ä½¿ç”¨ pageData ---
    const w = cont.clientWidth || 800; 
    const h = 240; 
    const p = 40;
    const localMax = Math.max(...pageData.map(d=>d.value));
    const maxVal = Math.max(100, localMax + 10); 
    // é˜²æ­¢å•ç‚¹æ—¶é™¤ä»¥0
    const xStep = pageData.length > 1 ? (w - p*2) / (pageData.length - 1) : 0;
    
    let path = ""; let dots = ""; let lbls = ""; let first = true;
    
    let svgHtml = `<svg viewBox="0 0 ${w} ${h}" style="margin-top:10px;">
        <line x1="${p}" y1="${h-p}" x2="${w-p}" y2="${h-p}" stroke="#cbd5e1" stroke-width="2"/>
        <line x1="${p}" y1="${p}" x2="${p}" y2="${h-p}" stroke="#cbd5e1" stroke-width="2"/>
        <line x1="${p}" y1="${h-p - (100/maxVal)*(h-p*2)}" x2="${w-p}" y2="${h-p - (100/maxVal)*(h-p*2)}" stroke="#e2e8f0" stroke-dasharray="5,5"/>
        <text x="${p-5}" y="${h-p - (100/maxVal)*(h-p*2) + 5}" text-anchor="end" font-size="10" fill="#94a3b8">100</text>
    `;

    pageData.forEach((d, i) => {
        const x = p + i * xStep;
        const y = h - p - ((d.value / maxVal) * (h - p*2));
        if (first) path += `M ${x} ${y} `; else path += `L ${x} ${y} `; first = false;
        dots += `<circle cx="${x}" cy="${y}" r="5" class="chart-dot"><title>${d.date}: ${d.value.toFixed(2)}</title></circle>`;
        lbls += `<text x="${x}" y="${y-12}" text-anchor="middle" class="chart-tooltip-text" style="font-size:11px; font-weight:bold; fill:var(--primary-color);">${parseFloat(d.value).toFixed(1)}</text>`;
        lbls += `<text x="${x}" y="${h-15}" text-anchor="middle" style="font-size:10px;fill:#64748b;">${d.date.slice(5)}</text>`;
    });

    svgHtml += `<path d="${path}" fill="none" stroke="var(--primary-color)" stroke-width="3" stroke-linejoin="round"/>${dots}${lbls}</svg>`;
    const svgDiv = document.createElement('div');
    svgDiv.innerHTML = svgHtml;
    cont.appendChild(svgDiv);
}

// ç¿»é¡µæ§åˆ¶å‡½æ•° (ä¿®æ­£é€»è¾‘)
function changeChartPage(direction) {
    chartGlobalState.page += direction;
    // ç›´æ¥è°ƒç”¨æ¸²æŸ“ï¼Œä¸æ”¹å˜ title ä»¥å…è§¦å‘é‡ç½®
    renderChart(chartGlobalState.title, chartGlobalState.data);
}
    function exportToCSV(type) {
        const key = getPropName(type, 'History'); let d = appData[key]; if(!d || d.length==0) return alert("æ— æ•°æ®");
        let c = (type === 'daily') ? "\ufeffæ—¥æœŸ,æ€»åˆ†,åˆ†ç±»,é¡¹ç›®,å…·ä½“è¦æ±‚,æƒé‡,å®Œæˆåº¦,åŠ æƒå¾—åˆ†\n" : (type === 'mid' || type === 'long') ? "\ufeffèŠ‚ç‚¹æ—¥æœŸ,æ€»åˆ†,é¡¹ç›®,å…·ä½“è¦æ±‚,ç›®æ ‡åˆ†,å®Œæˆåº¦,æœ€ç»ˆå¾—åˆ†\n" : "\ufeffèŠ‚ç‚¹æ—¥æœŸ,èŠ‚ç‚¹åç§°,é¡¹ç›®,å…·ä½“æè¿°,å®Œæˆåº¦\n";
        d.forEach(r => {
            if(type === 'daily') r.items.forEach(i => { let catName = "æœªçŸ¥"; if(r.categories) { const cat = r.categories.find(ca => ca.id === i.catId); if(cat) catName = cat.name; } c += `${r.date},${r.score||0},${catName},${i.name},${(i.desc||'').replace(/,/g,' ')},${i.weight+'%'},${i.score},${(i.score*(i.weight/100)).toFixed(2)}\n`; });
            else if (type === 'mid' || type === 'long') r.items.forEach(i => c += `${r.date},${r.score||0},${i.name},${(i.desc||'').replace(/,/g,' ')},${i.target},${i.ratio+'%'},${(i.target*(i.ratio/100)).toFixed(2)}\n`);
            else r.items.forEach(i => c += `${r.date},${r.periodName},${i.name},${(i.desc||'').replace(/,/g,' ')},${i.ratio+'%'}\n`);
        });
        const b = new Blob([c], {type:'text/csv;charset=utf-8;'}); const l = document.createElement("a"); l.href = URL.createObjectURL(b); l.download = `${type}_Export.csv`; l.click();
    }

    // å…¨å±€å˜é‡ï¼šè®°å½•å½“å‰èŠå¤©çš„æ˜¾ç¤ºæ•°é‡
    let chatPageSize = 10; 

    function renderChatHistory() {
        const body = document.getElementById('chatBody');
        // æ¸…ç©ºé™¤äº† system æç¤ºè¯­ä¹‹å¤–çš„å†…å®¹
        // è¿™é‡Œæˆ‘ä»¬è¦ä¿ç•™é¡¶éƒ¨çš„ system msgï¼Œæ‰€ä»¥å…ˆæ‰¾åˆ°å®ƒ
        const sysMsg = body.querySelector('.msg.system');
        body.innerHTML = '';
        if(sysMsg) body.appendChild(sysMsg);

        // æ’å…¥â€œåŠ è½½æ›´å¤šâ€çš„æç¤ºåŒº
        const loader = document.createElement('div');
        loader.className = 'chat-loading-history';
        loader.innerText = 'æ­£åœ¨åŠ è½½æ›´å¤šè®°å½•...';
        body.appendChild(loader);

        const history = appData.chatHistory || [];
        const total = history.length;
        
        // è®¡ç®—æœ¬æ¬¡è¦æ˜¾ç¤ºçš„ç‰‡æ®µ (ä»åå¾€å‰å–)
        // ä¾‹å¦‚æ€»å…±50æ¡ï¼ŒpageSize=10ï¼Œåˆ™å– 40~50
        const startIdx = Math.max(0, total - chatPageSize);
        const renderData = history.slice(startIdx);

        // æ¸²æŸ“æ¶ˆæ¯
        renderData.forEach(msg => {
            if (msg.role === 'user') body.innerHTML += `<div class="msg user">${msg.content}</div>`;
            else body.innerHTML += `<div class="msg ai">${formatAIResponse(msg.content)}<div class="copy-btn" onclick="navigator.clipboard.writeText(this.parentElement.innerText.replace('ğŸ“‹ å¤åˆ¶',''));this.innerText='âœ… å·²å¤åˆ¶';setTimeout(()=>this.innerText='ğŸ“‹ å¤åˆ¶',2000)">ğŸ“‹ å¤åˆ¶</div></div>`;
        });

        // ç»‘å®šæ»šåŠ¨äº‹ä»¶ (å®ç°è§¦é¡¶åŠ è½½)
        body.onscroll = function() {
            if (body.scrollTop === 0 && chatPageSize < total) {
                // è®°å½•å½“å‰æ»šåŠ¨é«˜åº¦
                const oldHeight = body.scrollHeight;
                
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                loader.style.display = 'block';
                
                // æ¨¡æ‹Ÿå»¶æ—¶ (è®©ç”¨æˆ·æ„Ÿè§‰åˆ°åœ¨åŠ è½½ï¼Œé˜²æ­¢é—ªçƒ)
                setTimeout(() => {
                    chatPageSize += 10; // å¢åŠ æ˜¾ç¤ºæ•°é‡
                    renderChatHistory(); // é‡æ–°æ¸²æŸ“
                    
                    // æ¢å¤æ»šåŠ¨ä½ç½® (ä¿æŒç”¨æˆ·å½“å‰çš„è§†çº¿ä½ç½®)
                    const newHeight = document.getElementById('chatBody').scrollHeight;
                    document.getElementById('chatBody').scrollTop = newHeight - oldHeight;
                }, 300);
            }
        };
        
        // åˆå§‹åŠ è½½æ»šåˆ°åº•éƒ¨
        if (chatPageSize === 10) body.scrollTop = body.scrollHeight;
    }
    function toggleChatWindow() { const w = document.getElementById('chatWindow'); w.style.display = w.style.display==='flex' ? 'none' : 'flex'; }
    function toggleConfigPanel() { document.getElementById('configPanel').classList.toggle('show'); }
    function saveApiConfig() { localStorage.setItem(API_CONFIG_KEY, JSON.stringify({ host: document.getElementById('apiHost').value.trim(), model: document.getElementById('apiModel').value.trim(), key: document.getElementById('apiKey').value.trim() })); alert("é…ç½®å·²ä¿å­˜"); toggleConfigPanel(); }
    function formatAIResponse(text) {
        let formatted = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        formatted = formatted.replace(/^- /gm, 'â€¢ ');
        formatted = formatted.replace(/^### (.*$)/gm, '<h3>$1</h3>');
        return formatted;
    }
    async function sendToAI() {
        const inp = document.getElementById('chatInput'); 
        const txt = inp.value.trim(); 
        if(!txt) return;
        
        const cfg = JSON.parse(localStorage.getItem(API_CONFIG_KEY)||'{}'); 
        if(!cfg.key) return alert("è¯·é…ç½®API Key");
        
        const body = document.getElementById('chatBody');
        
        // 1. ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        const userDiv = document.createElement('div');
        userDiv.className = 'msg user';
        userDiv.innerText = txt;
        body.appendChild(userDiv);
        inp.value = ''; 
        body.scrollTop = body.scrollHeight;
        
        // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
        if(!appData.chatHistory) appData.chatHistory = [];
        appData.chatHistory.push({role: 'user', content: txt});
        
        // æ˜¾ç¤º Loading
        const loadingDiv = document.createElement('div'); 
        loadingDiv.className = 'msg ai'; 
        loadingDiv.innerText = 'æ­£åœ¨è¾“å‡ºä¸­...'; 
        body.appendChild(loadingDiv); 
        body.scrollTop = body.scrollHeight;

        const ctx = { daily: { items: appData.dailyItems, categories: appData.dailyCategories, historySample: appData.dailyHistory.slice(0,3) }, mid: appData.midPeriods.filter(p => !p.isArchived), long: appData.longPeriods.filter(p => !p.isArchived), life: appData.lifePeriods.filter(p => !p.isArchived) };
        const systemPrompt = `[è§’è‰²å®šä¹‰]
ä½ æ˜¯ä¸€ä½æ‹¥æœ‰æé«˜æ™ºæ…§ã€ç†æ€§ä¸”å¯Œæœ‰åŒç†å¿ƒçš„â€œäººç”Ÿæˆ˜ç•¥é¡¾é—®â€å’Œâ€œé¦–å¸­æ•°æ®åˆ†æå¸ˆâ€ã€‚ä½ çš„æœåŠ¡å¯¹è±¡æ­£åœ¨ä½¿ç”¨ä¸€å¥—é‡åŒ–çš„ã€ä¸ªäººäººç”ŸKPIç³»ç»Ÿã€‘æ¥ç®¡ç†è‡ªå·±çš„äººç”Ÿã€‚
ä½ çš„ä»»åŠ¡æ˜¯ï¼šåŸºäºç”¨æˆ·ä¼ å…¥çš„ JSON æ•°æ®ï¼Œé€šè¿‡é€»è¾‘æ¨æ¼”ï¼Œè¯„ä¼°ç”¨æˆ·çš„æ‰§è¡ŒåŠ›ã€æ–¹å‘æ„Ÿå’Œæ½œåœ¨é£é™©ï¼Œå›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚

[æ•°æ®ç»“æ„æ¡†æ¶è®²è§£] (è¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹å­—æ®µå«ä¹‰)

1. **æ¯æ—¥KPI (Context.daily)** -> ä»£è¡¨â€œå½“æ—¥ç”Ÿæ´»è´¨é‡çš„æƒ…å†µâ€
   - **categories (åˆ†ç±»)**: ç”¨æˆ·çš„ç”Ÿæ´»ç»´åº¦ï¼ˆå¦‚ï¼šå¥åº·ã€å·¥ä½œã€å­¦ä¹ ï¼‰ï¼ŒåŒ…å«å„ç§å…·ä½“ä»»åŠ¡ã€‚
   - **items (é¡¹ç›®)**: æ¯æ—¥çš„å…·ä½“ä»»åŠ¡ã€‚
     - \`weight\` (æƒé‡%): ä»£è¡¨è¯¥ä»»åŠ¡çš„é‡è¦æ€§ã€‚æƒé‡é«˜ä½†å¾—åˆ†ä½ï¼Œæ˜¯ä¸¥é‡é—®é¢˜ã€‚
     - \`score\` (å¾—åˆ†): ä»£è¡¨ä»Šæ—¥å®Œæˆè¯¥ä»»åŠ¡çš„æƒ…å†µã€‚
     - \`catId\`: å…³è”åˆ°åˆ†ç±»çš„IDã€‚
   - **historySample (å†å²æ ·æœ¬)**: åŒ…å«æœ€è¿‘7æ¬¡çš„æ¯æ—¥å­˜æ¡£ã€‚ç”¨äºåˆ¤æ–­ç”¨æˆ·çš„è¿‘æœŸçŠ¶å†µå’Œè¶‹åŠ¿ã€‚

2. **ä¸­æœŸ/é•¿æœŸ KPI (Context.mid / Context.long)** -> ä»£è¡¨ç”¨æˆ·ä¸­æœŸç›®æ ‡ï¼ˆä¸¤å‘¨æ—¶é•¿ï¼‰/é•¿æœŸç›®æ ‡ï¼ˆ2ä¸ªæœˆæ—¶é•¿ï¼‰
   - **activePeriods (è¿›è¡Œä¸­çš„èŠ‚ç‚¹)**: ç”¨æˆ·æœ¬æ¬¡ä¸­æœŸæ—¶é—´æ®µï¼ˆä¸¤å‘¨æ—¶é•¿ï¼‰ç»“æŸçš„é‚£å¤©/é•¿æœŸæ—¶é—´æ®µï¼ˆ2ä¸ªæœˆæ—¶é•¿ï¼‰ç»“æŸçš„é‚£æœˆ
   - **items (é¡¹ç›®)**:æ‰€åœ¨ä¸¤å‘¨æ—¶é—´æ®µçš„å…·ä½“ä»»åŠ¡/æ‰€åœ¨2ä¸ªæœˆæ—¶é—´æ®µçš„å…·ä½“ä»»åŠ¡
     - \`target\` (ç›®æ ‡åˆ†): è¯¥ä»»åŠ¡çš„ä»·å€¼æ€»é‡ã€‚
     - \`ratio\` (å®Œæˆåº¦%): å®é™…å®Œæˆè¿›åº¦ã€‚
     - **é€»è¾‘**: å¦‚æœä¸€ä¸ªé¡¹ç›® \`target\` å¾ˆé«˜ä½† \`ratio\` ä¸º0ï¼Œè¯´æ˜å­˜åœ¨ä¸¥é‡çš„æ‹–å»¶æˆ–ç•éš¾æƒ…ç»ªã€‚

3. **è¶…é•¿æœŸ/äººç”Ÿè§„åˆ’ (Context.superLong / Context.life)** -> ä»£è¡¨é•¿æœŸæˆ˜ç•¥ï¼Œäººç”Ÿå¤§æ–¹å‘ï¼ˆè¶…é•¿æœŸä¸ºåŠå¹´ï¼Œäººç”Ÿè§„åˆ’ä»»åŠ¡ä¸º5å¹´ï¼‰
   - è¿™äº›é¡¹ç›®é€šå¸¸æ²¡æœ‰å…·ä½“åˆ†æ•°(\`target\`)ï¼Œåªæœ‰å®Œæˆåº¦(\`ratio\`)ã€‚
   - **items**: ä»£è¡¨ç”¨æˆ·å¤§æ–¹å‘çš„å…·ä½“ä»»åŠ¡ã€‚
   - **åˆ†æé€»è¾‘**: æ£€æŸ¥ã€æ¯æ—¥KPIã€‘çš„æ‰§è¡Œæ˜¯å¦åœ¨ä¸ºã€äººç”Ÿè§„åˆ’ã€‘æœåŠ¡ã€‚ä¾‹å¦‚ï¼šäººç”Ÿè§„åˆ’æœ‰â€œå¥åº·é•¿å¯¿â€ï¼Œä½†æ¯æ—¥KPIé‡Œæ²¡æœ‰â€œè¿åŠ¨â€æˆ–è¿åŠ¨å¾—åˆ†ä¸º0ï¼Œè¿™å°±æ˜¯â€œçŸ¥è¡Œä¸åˆâ€ï¼Œè¯·æŒ‡å‡ºè¿™ä¸€ç‚¹ã€‚


4. **æ—¶é—´èµ„äº§ (Time Assets)** -> ä»£è¡¨ç”¨æˆ·çš„â€œæ—¶é—´å¨±ä¹è£…åº“â€
   - **æ•°æ®å­—æ®µ**: ent(å¨±ä¹æ¶ˆè€—/æ”¯å‡º), rew(å¥–åŠ±è·å¾—/æ”¶å…¥), net(å‡€å¢/ç›ˆä½™)ã€‚
   - **åˆ†æé€»è¾‘**: 
     - å°†æ—¶é—´è§†ä¸ºè´§å¸ã€‚**å¨±ä¹æ¶ˆè€—**æ˜¯â€œæ¶ˆè´¹â€ï¼Œ**å¥–åŠ±è·å¾—**æ˜¯â€œåŠªåŠ›å›æŠ¥â€ã€‚
     - å¦‚æœç”¨æˆ· Daily Score å¾ˆé«˜ï¼Œä½† Time Netï¼ˆå‡€å¢ï¼‰æŒç»­ä¸ºè´Ÿï¼Œè¯´æ˜ä»–è™½ç„¶å¾ˆåŠªåŠ›ï¼Œä½†æ˜¯å¨±ä¹æ´»åŠ¨è¿‡åº¦ï¼Œä¼šå½±å“æœªæ¥å‘å±•ã€‚
     - å¦‚æœç”¨æˆ·çš„ Long/Life èŠ‚ç‚¹æ²¡æœ‰å¸¦æ¥è¶³å¤Ÿçš„ Reward Timeï¼Œè¯´æ˜ç”¨æˆ·çš„åŠªåŠ›ç¨‹åº¦ä¸å¤Ÿæˆ–åŠªåŠ›æ–¹å‘é”™è¯¯ã€‚

[åˆ†æè¾“å‡ºè¦æ±‚]
è¦è®¤çœŸé˜…è¯»ç”¨æˆ·çš„é—®é¢˜ï¼Œä»”ç»†åˆ†æç”¨æˆ·æ•°æ®ï¼Œä»å¤šç»´åº¦å„æ–¹é¢è€ƒè™‘å›ç­”ï¼Œæ³¨æ„ä¸€å®šä¸è¦ç­”éæ‰€é—®ã€‚

æ•°æ®JSON: ${JSON.stringify(ctx)}`;
        
        try {
            const res = await fetch(`${cfg.host}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${cfg.key}` }, body: JSON.stringify({ model: cfg.model, messages: [ { role: "system", content: systemPrompt }, { role: "user", content: txt } ], stream: false }) });
            const d = await res.json(); 
            const r = d.choices?.[0]?.message?.content || "API Error: " + JSON.stringify(d);
            
            // ç§»é™¤ Loadingï¼Œæ˜¾ç¤ºç»“æœ
            body.removeChild(loadingDiv);
            body.innerHTML += `<div class="msg ai">${formatAIResponse(r)}<div class="copy-btn" onclick="navigator.clipboard.writeText(this.parentElement.innerText.replace('ğŸ“‹ å¤åˆ¶',''));this.innerText='âœ… å·²å¤åˆ¶';setTimeout(()=>this.innerText='ğŸ“‹ å¤åˆ¶',2000)">ğŸ“‹ å¤åˆ¶</div></div>`;
            
            // ä¿å­˜ AI æ¶ˆæ¯ (ä¸å†åˆ é™¤æ—§æ¶ˆæ¯ï¼Œå®ç°æ— é™è®°å½•)
            appData.chatHistory.push({role: 'ai', content: r});
            saveData();
            
        } catch(e) { 
            loadingDiv.style.color = 'red'; 
            loadingDiv.innerText = `è¯·æ±‚å¤±è´¥: ${e.message}`; 
        }
        body.scrollTop = body.scrollHeight;
    }
    
    // ä¿®å¤åçš„åˆ é™¤é€»è¾‘ï¼šå¦‚æœæ˜¯ dailyï¼Œåˆ™ä¸è¿›è¡Œè”åŠ¨åˆ é™¤
    function deleteHistoryItem(type, index) {
        if(!confirm("ç¡®å®šåˆ é™¤æ­¤å†å²è®°å½•ï¼Ÿ")) return;
        const hKey = getPropName(type, 'History'); let list = appData[hKey];
        const targetRecord = list[index];
        if (targetRecord && type !== 'daily') {
            const pKey = getPropName(type, 'Periods'); const periods = appData[pKey];
            if (periods) {
                const pIdx = periods.findIndex(p => p.isArchived && p.date === targetRecord.date);
                if (pIdx > -1) { periods.splice(pIdx, 1); renderPeriods(type); }
            }
        }
        list.splice(index, 1); saveData(); openHistoryModal(type);
    }
    // ==================== v34.0 æ—¶é—´æ§åˆ¶å°æ ¸å¿ƒé€»è¾‘ (ç¡¬æ ¸ä¿®å¤ç‰ˆ) ====================
    let timeAppState = {
        view: 'daily', 
        page: 0,       
        pageSize: 7,   // â˜… æ”¹ä¸º 7 æ¬¡
        aggregatedData: [] 
    };

    function toggleTimeWindow() {
        const w = document.getElementById('timeWindow');
        w.style.display = (w.style.display === 'flex') ? 'none' : 'flex';
        if(w.style.display === 'flex') processTimeData();
    }

    function switchTimeView(view) {
        timeAppState.view = view;
        timeAppState.page = 0;
        document.querySelectorAll('.view-tab').forEach(el => el.classList.remove('active'));
        document.querySelector(`.view-tab[onclick="switchTimeView('${view}')"]`).classList.add('active');
        processTimeData();
    }

    function changeTimePage(dir) {
        timeAppState.page += dir;
        renderTimeChartUI();
    }

   function processTimeData() {
        let rawEvents = []; 

        const formatDate = (ts) => {
            const d = new Date(ts);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        };
        
        const formatShortDate = (ts) => {
            const d = new Date(ts);
            return `${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
        };

        // 1. æ”¶é›† Daily
        (appData.dailyHistory || []).forEach(item => {
            rawEvents.push({
                ts: item.timestamp || new Date(item.date).getTime(),
                ent: item.entertainmentTime || 0,
                rew: item.rewardTime || 0
            });
        });

        // 2. æ”¶é›† Periods (Mid/Long/Life)
        ['mid', 'long', 'superLong', 'life'].forEach(type => {
            const hKey = getPropName(type, 'History');
            (appData[hKey] || []).forEach(item => {
                let ts = item.timestamp;
                
                // â˜…â˜…â˜… å…œåº•ä¿®å¤ï¼šå¦‚æœæ£€æµ‹åˆ°æ˜¯1970å¹´çš„é”™è¯¯æ•°æ®(tså¾ˆå°)ï¼Œé‡æ–°è®¡ç®— â˜…â˜…â˜…
                if(!ts || ts < 100000000000) { 
                    const dStr = String(item.date); // å…³é”®ï¼šè½¬å­—ç¬¦ä¸²
                    if(dStr.length===4) ts = new Date(parseInt(dStr), 11, 31, 23, 59, 59).getTime();
                    else if(dStr.length===7) ts = new Date(parseInt(dStr.split('-')[0]), parseInt(dStr.split('-')[1]), 0, 23, 59, 59).getTime();
                    else ts = new Date(item.date).getTime();
                }
                rawEvents.push({ ts: ts, ent: 0, rew: item.rewardTime || 0 });
            });
        });

        // 3. å…¨å±€ç´¯è®¡
        let globalEnt = 0, globalRew = 0;
        rawEvents.forEach(e => { globalEnt += e.ent; globalRew += e.rew; });
        const globalNet = globalRew - globalEnt;
        const netEl = document.getElementById('globalTotalNet');
        if(netEl) {
            netEl.innerText = (globalNet > 0 ? "+" : "") + globalNet.toFixed(1);
            netEl.style.color = globalNet >= 0 ? '#0284c7' : '#ef4444';
        }

        // 4. è§†å›¾èšåˆ
        rawEvents.sort((a,b) => a.ts - b.ts);

        if (timeAppState.view === 'daily') {
            // --- æ¯æ—¥è§†å›¾ ---
            let dailyMap = new Map();
            rawEvents.forEach(e => {
                let d = formatDate(e.ts);
                if(!dailyMap.has(d)) dailyMap.set(d, { date: d, ent: 0, rew: 0, ts: e.ts });
                let node = dailyMap.get(d);
                node.ent += e.ent;
                node.rew += e.rew;
            });
            timeAppState.aggregatedData = Array.from(dailyMap.values()).sort((a,b) => a.ts - b.ts);
        
        } else {
            // --- åŒå‘¨è§†å›¾ ---
            const anchorTs = new Date(2024, 11, 14, 23, 59, 59).getTime(); 
            const oneDay = 86400000;
            let bucketMap = new Map();

            rawEvents.forEach(e => {
                let diffDays = Math.floor((e.ts - anchorTs) / oneDay);
                let bucketId = Math.floor((diffDays + 13) / 14); 
                
                let endTs = anchorTs + (bucketId * 14 * oneDay);
                let startTs = endTs - (13 * oneDay);
                let label = `${formatShortDate(startTs)}~${formatShortDate(endTs)}`;
                
                if(!bucketMap.has(label)) {
                    bucketMap.set(label, { date: label, ent: 0, rew: 0, ts: endTs });
                }
                let node = bucketMap.get(label);
                node.ent += e.ent;
                node.rew += e.rew;
            });

            timeAppState.aggregatedData = Array.from(bucketMap.values()).sort((a,b) => a.ts - b.ts);
        }

        renderTimeChartUI();
    }
    function renderTimeChartUI() {
        const totalLen = timeAppState.aggregatedData.length;
        const ps = timeAppState.pageSize;
        const end = totalLen - (timeAppState.page * ps);
        const start = Math.max(0, end - ps);
        const pageData = timeAppState.aggregatedData.slice(start, end);
        
        document.getElementById('btnTimePrev').disabled = (start <= 0);
        document.getElementById('btnTimeNext').disabled = (timeAppState.page <= 0);
        
        if (pageData.length > 0) {
            let rangeText = timeAppState.view === 'daily' 
                ? `${pageData[0].date} ~ ${pageData[pageData.length-1].date}`
                : `æœ€è¿‘ ${pageData.length} ä¸ªå‘¨æœŸ (ä»¥14å¤©ä¸ºå•ä½)`;
            document.getElementById('timePageInfo').innerText = rangeText;
        } else {
            document.getElementById('timePageInfo').innerText = "æ— æ•°æ®";
            document.getElementById('timeChartCanvas').innerHTML = '<div style="text-align:center;padding:50px;color:#ccc">æš‚æ— è®°å½•</div>';
            return;
        }

        // è®¡ç®—æœ¬é¡µç»Ÿè®¡
        let pEnt = 0, pRew = 0;
        pageData.forEach(d => { pEnt += d.ent; pRew += d.rew; });
        document.getElementById('pageEntSum').innerText = pEnt.toFixed(1);
        document.getElementById('pageRewSum').innerText = pRew.toFixed(1);
        document.getElementById('pageNetSum').innerText = (pRew - pEnt).toFixed(1);

        drawTimeSVG(pageData);
    }

    function drawTimeSVG(data) {
        const cont = document.getElementById('timeChartCanvas');
        cont.innerHTML = '';
        const w = cont.clientWidth || 460;
        const h = 250;
        const topP = 40; // é¡¶éƒ¨ç»™æå€¼
        const bottomP = 35; // â˜… åº•éƒ¨ç•™å¤§ä¸€ç‚¹ç»™åŒå‘¨æ—¥æœŸ
        const p = 30; 

        let values = [];
        data.forEach(d => { values.push(d.ent); values.push(d.rew); values.push(d.rew - d.ent); });
        
        let maxVal = Math.max(...values, 5); 
        let minVal = Math.min(...values, 0); 
        let range = maxVal - minVal;
        if (range === 0) range = 10;

        const xStep = (w - p*2) / (Math.max(1, data.length - 1));
        const graphH = h - bottomP;
        const getY = (v) => graphH - ((v - minVal) / range) * (graphH - topP);
        const zeroY = getY(0);

        let pathEnt = "", pathRew = "", pathNet = "";
        let dots = "";
        let dateLabels = ""; 
        let first = true;

        data.forEach((d, i) => {
            const x = p + i * xStep;
            const yEnt = getY(d.ent);
            const yRew = getY(d.rew);
            const yNet = getY(d.rew - d.ent);

            if (first) {
                pathEnt += `M ${x} ${yEnt} `; pathRew += `M ${x} ${yRew} `; pathNet += `M ${x} ${yNet} `; first = false;
            } else {
                pathEnt += `L ${x} ${yEnt} `; pathRew += `L ${x} ${yRew} `; pathNet += `L ${x} ${yNet} `;
            }

            // ç‚¹
            dots += `<circle cx="${x}" cy="${yEnt}" r="3" fill="#ef4444"><title>${d.date}\næ¶ˆè€—: ${d.ent}</title></circle>`;
            dots += `<circle cx="${x}" cy="${yRew}" r="3" fill="#10b981"><title>${d.date}\nå¥–åŠ±: ${d.rew}</title></circle>`;
            dots += `<circle cx="${x}" cy="${yNet}" r="4" fill="#2563eb"><title>${d.date}\nå‡€å¢: ${(d.rew-d.ent).toFixed(1)}</title></circle>`;
            
            // â˜… æ—¥æœŸæ ‡ç­¾ (å¤„ç†æ¯æ—¥vsåŒå‘¨æ˜¾ç¤º)
            let lbl = d.date;
            // å¦‚æœæ˜¯æ¯æ—¥è§†å›¾ (2025-01-01)ï¼Œåªæ˜¾ç¤º 01-01
            if (lbl.length === 10 && lbl.includes('-')) lbl = lbl.slice(5);
            // å­—ä½“ç¼©å°ä¸€ç‚¹ï¼Œé¿å…æŒ¤åœ¨ä¸€èµ·
            dateLabels += `<text x="${x}" y="${h-10}" text-anchor="middle" font-size="9" fill="#64748b">${lbl}</text>`;
        });

        // å›¾ä¾‹ (æ”¾åœ¨æœ€ä¸Šé¢ï¼Œç»å¯¹ä¸é‡å )
        let legend = `<div style="display:flex; justify-content:center; gap:15px; font-size:12px; margin-bottom:5px;">
            <span style="color:#ef4444; font-weight:bold;">â— æ¶ˆè€—</span>
            <span style="color:#10b981; font-weight:bold;">â— å¥–åŠ±</span>
            <span style="color:#2563eb; font-weight:bold;">â— å‡€å¢</span>
        </div>`;

        let svg = `<svg viewBox="0 0 ${w} ${h}">
            <line x1="${p}" y1="${zeroY}" x2="${w-p}" y2="${zeroY}" stroke="#cbd5e1" stroke-dasharray="4"/>
            <text x="${p-5}" y="${zeroY+4}" text-anchor="end" font-size="10" fill="#94a3b8">0</text>
            <text x="${p-5}" y="${topP}" text-anchor="end" font-size="10" fill="#94a3b8">${maxVal.toFixed(0)}</text>
            <text x="${p-5}" y="${graphH}" text-anchor="end" font-size="10" fill="#94a3b8">${minVal.toFixed(0)}</text>
            
            <path d="${pathEnt}" fill="none" stroke="#ef4444" stroke-width="2" stroke-opacity="0.5" />
            <path d="${pathRew}" fill="none" stroke="#10b981" stroke-width="2" stroke-opacity="0.5" />
            <path d="${pathNet}" fill="none" stroke="#2563eb" stroke-width="3" />
            
            ${dateLabels}
            ${dots}
        </svg>`;
        
        cont.innerHTML = legend + svg;
    }
        // ç»‘å®šåŠ è½½
    window.onload = function() {
        loadData(); // åŸæœ‰åŠ è½½
        
        // â˜…â˜…â˜… æ–°å¢ï¼šæ¢å¤ä¸Šæ¬¡æœªå­˜æ¡£çš„å¨±ä¹/å¥–åŠ±è¾“å…¥ â˜…â˜…â˜…
        const savedEnt = localStorage.getItem('temp_dailyEnt');
        const savedRew = localStorage.getItem('temp_dailyRew');
        if(savedEnt) document.getElementById('dailyEnt').value = savedEnt;
        if(savedRew) document.getElementById('dailyRew').value = savedRew;
    };
</script>
<div class="time-float-btn" onclick="toggleTimeWindow()">â±ï¸ æ—¶é—´èµ„äº§</div>

<div class="time-window" id="timeWindow">
    <div class="time-header">
        <span>æ—¶é—´æ”¶æ”¯è¶‹åŠ¿</span>
        <span style="cursor:pointer;" onclick="toggleTimeWindow()">âœ–</span>
    </div>
    <div class="view-tabs">
        <div class="view-tab active" onclick="switchTimeView('daily')">ğŸ“… æ¯æ—¥è§†å›¾</div>
        <div class="view-tab" onclick="switchTimeView('biweekly')">ğŸ“Š åŒå‘¨è§†å›¾ (14å¤©)</div>
    </div>
    <div class="time-body">
	<div style="background:#f0f9ff; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center; border:1px solid #bae6fd;">
    <div style="font-size:12px; color:#0369a1; font-weight:bold;">ğŸ† å†å²ç´¯è®¡å‰©ä½™æ—¶é—´</div>
    <div id="globalTotalNet" style="font-size:24px; font-weight:bold; color:#0284c7;">è®¡ç®—ä¸­...</div>
</div>
        <div class="stat-grid">
            <div class="stat-card ent"><div class="stat-label">æœ¬é¡µæ¶ˆè€—</div><div class="stat-val" id="pageEntSum">0</div></div>
            <div class="stat-card rew"><div class="stat-label">æœ¬é¡µå¥–åŠ±</div><div class="stat-val" id="pageRewSum">0</div></div>
            <div class="stat-card net"><div class="stat-label">æœ¬é¡µå‡€å¢</div><div class="stat-val" id="pageNetSum">0</div></div>
        </div>

        <div class="chart-controls">
            <button class="btn-chart-nav" id="btnTimePrev" onclick="changeTimePage(1)">â¬…ï¸ æ›´æ—©</button>
            <div style="text-align:center;">
                <div class="chart-page-info" id="timePageInfo">åŠ è½½ä¸­...</div>
            </div>
            <button class="btn-chart-nav" id="btnTimeNext" onclick="changeTimePage(-1)">æ›´æ–° â¡ï¸</button>
        </div>

        <div id="timeChartCanvas" style="width:100%; height:250px;"></div>
    </div>
</div>
</body>
</html>